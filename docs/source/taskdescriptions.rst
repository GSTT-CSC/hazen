Task descriptions
=================================
The *hazen* application provides automatic quantitative analysis for MRI data acquired with either the ACR phantom or MagNET phantoms. Analysis is based on guidance from IPEM\ :footcite:p:`2017:ipem112`\ :sup:`,` :footcite:p:`1999:ipem80`, ACR\ :footcite:p:`2015:acrQC` and MagNET.

Please refer to **acquisition requirements** for detail related to the acquisition of phantom images, as well as **input requirements** for the required folder structure for hazen input.


Signal-to-noise ratio (SNR)
------------------------------
SNR is a measure of how the signal and hence the pixel intensity in the image is affected by random fluctuations referred to as noise. Sources of noise can include the RF coil and receiver system or inhomogeneities in the magnetic field. The choice of sequence type and parameters also affect SNR.

Hazen calculates the SNR using a subtraction method\ :footcite:p:`2017:ipem112` or a smoothing method\ :footcite:p:`2013:mcann`. A normalised SNR is also calculated which accounts for voxel size, bandwidth, repetition time and number of measurements.

The subtraction method is considered more accurate and uses two identical single-slice images of a flood or uniform section of a phantom. The signal is measured in five regions of interest (ROI) placed across the phantom. The noise image is generated by subtracting the two acquisitions. Noise is measured as the standard deviation in each ROI in the noise image. The average of the SNR in the five ROIs is reported.

The smoothing method uses a single slice of a flood or uniform section of a phantom. The signal is measured in five ROIs placed across the phantom. A smoothing filter is applied to the image to remove low-frequency trends and the noise image is generated by subtracting the smoothed image from the original image. Noise is measured as the standard deviation in the same five ROIs in the noise image. The average of the SNR in the five ROIs is reported.

ACR
^^^^^^^^^^^^^^^^^^^^^^^^^^^
The *acr_snr* task measures SNR in the flood field region, on slice 7 of the ACR phantom. By default, the task uses the smoothing method and Hazen will output both the measured and normalised SNR. The subtraction method can be used by providing a second data set using the *subtract* task option. A more accurate normalised snr can be calculated with the *measured_slice_width* task option.

.. figure:: /_static/snr_ROIs.png
   :width: 300
   :height: 300
   :align: center

   Regions of interest used to measure SNR

MagNET
^^^^^^^^^^^^^^^^^^^^^^^^^^^
The *snr* task measures SNR on an image of the MagNET flood field test object (or any other flood field/uniform phantom). Depending on the number of images provided, Hazen will calculate SNR via the smoothing method or via both the smoothing and subtraction methods. Both measured and normalised SNR are outputted.  Measured slice width can be provided as a task option to give a more accurate normalised SNR.


SNR map
---------------------
The *snr map* task can be used with either the ACR phantom or MagNET flood field test object.

The SNR map can show variation in SNR caused by smoothing filters. It also highlights small regions of low signal which could be caused by microbubbles or foreign bodies in the phantom. These inhomogeneities can erroneously reduce SNR measurements made by other methods.

SNR is calculated for each voxel by calculating the SNR in an ROI centred on that voxel. SNR is calculated via the smoothing method.


Spatial resolution
---------------------
Spatial resolution describes the ability of any imaging system to distinguish small objects. For MRI, the higher the spatial frequencies acquired the smaller the pixel size and the better the spatial resolution.

Factors affecting spatial resolution include magnetic field inhomogeneities, eddy currents, imperfections in the gradient system as well as filtering of the acquired spatial frequency data.

High-contrast spatial resolution can be assessed quantitatively through the modulation transfer function (MTF) and line spread function (LSF)\ :footcite:p:`2017:ipem112`.

The MTF describes how the range of spatial frequencies of an object are modulated during the image formation process. It can be calculated by taking the Fourier transformation of the line spread function (LSF), derived from measurement and differentiation of the edge response function (ERF), obtained by taking a profile across a sharp high-contrast step (e.g. the edge of a block).

MagNET
^^^^^^^^^^^^^^^^^^^^^^^^^^^
The *spatial_resolution* task measures spatial resolution with the MagNET resolution test object by calculating the MTF from the edges of the Perspex block which is angled at 10 degrees to the horizontal and vertical.

A square ROI is selected that encompasses the central Perspex block,  and an edge response function is generated for both the top and right edges of the block.  This is then used to determine the LSF and subsequent MTF for each edge. Hazen outputs the measurement of spatial resolution in both the frequency and phase encoding directions.


Uniformity
----------
Uniformity is a measure of the ability of the MRI system to produce a constant signal response over the imaging volume. Factors affecting uniformity include RF homogeneity, B0 homogeneity and eddy current correction.

Uniformity can be quantified via either the fractional\ :footcite:p:`1999:ipem80` or integral\ :footcite:p:`2015:acrQC` uniformity method.

ACR
^^^^^^^^^^^^^^^^^^^^^^^^^^^
The *acr_uniformity* task calculates percentage integral uniformity in slice 7 of the ACR phantom.

A 200cm\ :sup:`2` ROI is first defined in the centre of the slice before placing 1cm\ :sup:`2` ROIs at every pixel within the large ROI. The mean pixel value of each 1cm\ :sup:`2` ROI is calculated and the minimum and maximum values are used to calculate integral uniformity.

.. figure:: /_static/acr_uni_analysis.png
   :width: 300
   :height: 300
   :align: center

   Regions of interest used to measure uniformity with the ACR phantom

MagNET
^^^^^^^^^^^^^^^^^^^^^^^^^^^
The *uniformity* task calculates fractional uniformity for a single-slice image of the MagNET flood field test object.

To measure fractional uniformity, the modal value in a 10x10 pixel ROI at the centre of the image is first measured. The average of ten 160-pixel profiles at the image centre is then taken in both the horizontal and vertical directions. Fractional uniformity is given by the fraction of pixels in the horizontal and vertical profiles that are within 90-110% of the centre modal value.

.. figure:: /_static/magnet_uniformity.png
   :width: 660
   :height: 320
   :align: center

   Regions of interest used to measure uniformity with the ACR phantom


Ghosting
------------------
Ghosting is a type of artefact that appears as repeated low intensity copies of the main object displaced within the image. Ghosting can occur due to a variety of causes, arising from the equipment or sequence parameters and even the object being scanned.

ACR
^^^^^^^^^^^^^^^^^^^^^^^^^^
The *acr_ghosting* task measures the ghosting ratio on slice 7 of the ACR phantom.

The percent-signal ghosting is calculated by defining a large central 200cm\ :sup:`2` ROI and four elliptical 10cm\ :sup:`2` ROI’s in the background along the cardinal directions. The mean pixel value in each ROI is used to calculate the percent-signal ghosting.

.. figure:: /_static/acr_ghosting_analysis.png
   :width: 300
   :height: 300
   :align: center

   Regions of interest used to measure ghosting with the ACR phantom

MagNET
^^^^^^^^^^^^^^^^^^^^^^^^^^
The *ghosting* task measures the percent-signal ghosting using the small bottle method as described in IPEM 112.

Ghosting is measured by utilising ROI’s to evaluate the true phantom signal, the signal in regions of ghosting in line with the phantom in the phase-encoding direction and the background noise level. Hazen outputs a ghosting ratio for each echo time.

.. figure:: /_static/magnet_ghosting_analysis.png
   :width: 300
   :height: 300
   :align: center

   Regions of interest used to measure ghosting with the small bottle phantom


Slice Position
-------------------------
Slice position accuracy tests how well the actual locations of slices differ from their prescribed locations. Slice selection accuracy depends on the homogeneity of B0, gradient linearity and proper calibration of gradient amplitudes.

ACR
^^^^^^^^^^^^^^^^^^^^^^^^^^^
The *acr_slice_position* task measures slice position on slices 1 and 11 of the ACR phantom.

The crossing wedges positioned at the superior and inferior ends of the phantom are visualised on slices 1 and 11 as adjacent dark bars. If there is perfect agreement between the nominal and measured slice position, then the bars will have equal length on the image. If the slice is displaced superiorly with respect to the vertex, the bar on the observer’s right (anatomical left) will be longer. If the slice is displaced inferiorly with respect to the vertex, the bar on the observer’s left will be longer. Hazen outputs the bar length difference, which is twice the slice position displacement, for both slices 1 and 11. A negative sign is assigned to an inferior displacement.

.. figure:: /_static/acr_slice_position.png
   :width: 684
   :height: 348
   :align: center

   Slices 1 and 11 of the ACR phantom are used to measure slice position

MagNET
^^^^^^^^^^^^^^^^^^^^^^^^^^^
The *slice_position* task uses the slice position MagNET test object.  The test object contains two angled glass rods and four parallel glass rods. The distance between the angled rods is used to measure the agreement between the nominal slice position and the measured slice position.  Hazen outputs both the maximum and average slice position error.


Slice Width
-------------------------
Slice width is a measure of the slice thickness compared to the nominal slice thickness and is affected by the RF pulse shape, the homogeneity of the B0 field, and gradient linearity.

ACR
^^^^^^^^^^^^^^^^^^^^^^^^^^^
The *acr_slice_thickness* task measures slice width on slice 1 of the ACR phantom where there are two crossing ramps inclined at equal and opposite angles to the acquisition plane. The full-width half-maximum of each ramp is determined and used to calculate slice thickness.

.. figure:: /_static/acr_slice_width.png
   :width: 300
   :height: 300
   :align: center

   Slice 1 of the ACR phantom is used to measure slice width

MagNET
^^^^^^^^^^^^^^^^^^^^^^^^^^^
The *slice_width* task measures slice width with the MagNET geometric test object, which contains two angled glass plates. The full-width half-maximum of each ramp is used along with the known angle of the ramp to calculate slice width. The average of both ramps is then calculated. Hazen outputs the slice width along with measures of linearity and distortion- see **Geometric accuracy**.


Geometric Accuracy
-------------------------
Geometric accuracy is a measure of the amount of geometric distortion within an image and is affected by the homogeneity of the B0 field. Geometric distortions are inherent to MRI systems and typically increase with distance from isocentre.

ACR
^^^^^^^^^^^^^^^^^^^^^^^^^^
The *acr_geometric_accuracy* task quantifies geometric distortion by measuring the phantom diameter on slice 1 and 5 and comparing this to the known diameter (19cm).

On slice 1, the diameter is measured in the horizontal and vertical directions and on slice 5 the diameter is measured in the horizontal, vertical and two diagonal directions. Hazen outputs each measured distance as well as the maximum error, minimum error and coefficient of variation for all five measurements.

.. figure:: /_static/acr_geom_measurements.png
   :width: 684
   :height: 348
   :align: center

   Diameters on slices 1 and 5 used to measure geometric accuracy

MagNET
^^^^^^^^^^^^^^^^^^^^^^^^^^
The *slice_width* task measures geometric linearity and distortion for the MagNET geometric test object. The test object contains a series of Perspex rods which are used to make three horizontal and three vertical measures of distance. Hazen outputs each measured distance as well as the average in both directions. Geometric linearity can be quantified via the error between the measured distance and known distance.

Geometric distortion is quantified via the coefficient of variation of the errors between the measured distance and actual distance. Hazen outputs the coefficient of variation in both directions.


Relaxometry
--------------------------
Relaxometry is measurement of relaxation times from MR images. Within *hazen*, we determine the T1 and T2 decay constants for the relaxometry spheres in the `Caliber (HPD) system phantom <https://qmri.com/contrast-mri/>`_.

Values are compared to published values (without temperature correction), and graphs of fit and phantom registration images can optionally be produced.

To summarise the algorithm used, we:

#. Create ``T1ImageStack`` or ``T2ImageStack`` object which stores a list of individual DICOM files (as ``pydicom`` objects) in the ``.images`` attribute.
#. Obtain the RT (rotation / translation) matrix to register the template image to the test image. Four template images are provided, one for each relaxation parameter (T1 or T2) on plates 4 and 5, and regression is performed on the first image in the sequence. We can optionally output the overlay image to visually check the fit.
#. An ROI is generated for each target sphere using stored coordinates, the RT transformation above, and a structuring element (default is a 5x5 boxcar).
#. Store pixel data for each ROI, at various times, in an ``ROITimeSeries`` object. A list of these objects is stored in ``ImageStack.ROI_time_series``.
#. Generate the fit function. For T1 this looks up TR for the given TI (using piecewise linear interpolation if required) and determines if a magnitude or signed image is used. No customisation is required for T2 measurements.
#. Determine relaxation time (T1 or T2) by fitting the decay equation to the ROI data for each sphere. The published values of the relaxation times are used to seed the optimisation algorithm. For T2 fitting the input data are truncated for TE > 5*T2 to avoid fitting Rician noise in magnitude images with low signal intensity. We can optionally plot and save the decay curves.
#. Return plate number, relaxation type (T1 or T2), measured relaxation times, published relaxation times, and fractional differences in a dictionary.

.. note::
   As some scanners may require a longer TR for long TI values, this algorithm will accommodate a variation in TR with TI and incomplete recovery due to short TR.

.. todo::
   - Template fit on bolt holes--possibly better with large rotation angles -have bolthole template, find 3 positions in template and image, figure out transformation.
   - Template fit on outline image--poss run though edge detection algorithms then fit.
   - Use normalised structuring element in ROITimeSeries. This will allow correct calculation of mean if elements are not 0 or 1.
   - Get r-squared measure of fit.


References
------------------

.. footbibliography::
