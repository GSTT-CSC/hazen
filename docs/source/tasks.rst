Tasks
=================================
The *hazen* application provides automatic quantitative analysis for the following measurements of MRI phantom data:

Signal-to-noise ratio (SNR)
^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. image:: /_static/snr.jpg
   :width: 300
   :align: center

The SNR is a measure of how the signal and hence the pixel intensity in the image is affected by random fluctuations referred to as noise. Sources of noise can include the RF coil and receiver system or inhomogeneities in the magnetic field. The choice of sequence type and parameters also affect the SNR measurements.

Hazen calculates the SNR using a subtraction method\ :footcite:p:`2017:ipem112`. Two single-slice images of a flood or uniform section of a phantom are acquired in three orientations under identical conditions. Then the noise is calculated in the script from an image generated by subtracting the two. For the calculations, five ROIs are placed across the phantom.

Spatial resolution
^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. image:: /_static/sp_res.jpg
   :width: 300
   :align: center

Spatial resolution describes the ability of any imaging system to distinguish small objects. For MRI the higher the spatial frequencies acquired, the smaller the pixel size and the better the spatial resolution.

Factors affecting spatial resolution include magnetic field inhomogeneities, eddy currents, imperfections in the gradient system as well as filtering of the acquired spatial frequency data.

High-contrast spatial resolution can be assessed quantitatively through investigating the modulation transfer function (MTF) and line spread function (LSF).

The MTF describes how the range of spatial frequencies of an object are modulated during the image formation process.It can be calculated by taking the Fourier transformation of the line spread function (LSF), derived from measurement and differentiation of the edge response function (ERF), obtained by taking a profile across a sharp high-contrast step (e.g. the edge of a block).

.. todo::
   Replace shape finding functions with ``hazenlib.tools`` equivalents

Slice position and width
^^^^^^^^^^^^^^^^^^^^^^^^^^^

.. image:: /_static/slice_par.jpg
   :width: 300
   :align: center

Slice position accuracy tests how well the actual locations of slices differ from their prescribed locations.

Therefore, the agreement between a nominal slice position and the measured slice position is calculated from 60
appropriately acquired coronal images. The inserts as seen in the image below should be positioned vertically for the
script to function.

Uniformity
^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. image:: /_static/uniformity.jpg
   :width: 300
   :align: center

Uniformity is a measure of the ability of the MRI system to produce a constant signal response over the imaging volume.

To calculate uniformity for a single-slice image of a uniform MRI phantom, the suggested method by the IPEM 80 is the measurement of fractional uniformity.

This method:

- Finds modal value in 10x10 pixel ROI (red square) at phantom image centre.
- Finds average of ten horizontal and vertical 160-pixel profiles at phantom image centre (yellow and green rectangles).
- Reports fraction of pixels in horizontal and vertical profiles within 90-110% of centre modal value.

Ghosting
^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. image:: /_static/ghost.jpg
   :width: 300
   :align: center

Ghosting is a type of structured noise appearing as repeated ow intensity copies  of the main object displaced within the image. Ghosting can occur due to a variety of causes, arising from the equipment or sequence parameters and even the object being scanned.

Two sets of images an off-centre phantom are acquired with one and two signal averages at different echo times (30,60,90,120 ms).

The Hazen script then measures ghosting by utilizing ROIs to evaluate the true phantom signal, the signal in regions of ghosting in line with phantom in the phase-encoding direction, as well as the background noise level (right ROIs)(Lerski et al., 1988).

Relaxometry
^^^^^^^^^^^^^^^^^^^^^^^^^^^
Relaxometry is measurement of relaxation times from MR images. Within `hazen`, we determine the T1 and T2 decay constants for the relaxometry spheres in the `Caliber (HPD) system phantom <https://qmri.com/contrast-mri/>`_.

Values are compared to published values (without temperature correction), and graphs of fit and phantom registration images can optionally be produced.

To summarise the algorithm used, we:

#. Create ``T1ImageStack`` or ``T2ImageStack`` object which stores a list of individual DICOM files (as ``pydicom`` objects) in the ``.images`` attribute.
#. Obtain the RT (rotation / translation) matrix to register the template image to the test image. Four template images are provided, one for each relaxation parameter (T1 or T2) on plates 4 and 5, and regression is performed on the first image in the sequence. We can optionally output the overlay image to visually check the fit.
#. An ROI is generated for each target sphere using stored coordinates, the RT transformation above, and a structuring element (default is a 5x5 boxcar).
#. Store pixel data for each ROI, at various times, in an ``ROITimeSeries`` object. A list of these objects is stored in ``ImageStack.ROI_time_series``.
#. Generate the fit function. For T1 this looks up TR for the given TI (using piecewise linear interpolation if required) and determines if a magnitude or signed image is used. No customisation is required for T2 measurements.
#. Determine relaxation time (T1 or T2) by fitting the decay equation to the ROI data for each sphere. The published values of the relaxation times are used to seed the optimisation algorithm. For T2 fitting the input data are truncated for TE > 5*T2 to avoid fitting Rician noise in magnitude images with low signal intensity. We can optionally plot and save the decay curves.
#. Return plate number, relaxation type (T1 or T2), measured relaxation times, published relaxation times, and fractional differences in a dictionary.

.. note::
   As some scanners may require a longer TR for long TI values, this algorithm will accommodate a variation in TR with TI and incomplete recovery due to short TR.

.. todo::
   - Template fit on bolt holes--possibly better with large rotation angles -have bolthole template, find 3 positions in template and image, figure out transformation.
   - Template fit on outline image--poss run though edge detection algorithms then fit.
   - Use normalised structuring element in ROITimeSeries. This will allow correct calculation of mean if elements are not 0 or 1.
   - Get r-squared measure of fit.

References
^^^^^^^^^^

.. footbibliography::
