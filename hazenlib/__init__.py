"""
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNddddddddddhdddhmmhdmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMmmmddddmMMMmmmMMMMMNNNMMNNmhyyhddddNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMNddddsyhyysyhhmmhdhhhhdmdhddhNmmdhhdhhdmmNhhdhdMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMmmdydds++sddyydmmNMMMNMNNNNNMNNNNNNNMNMNyso+syhhdmdhhmMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMNdyosyhooohhdssyhMMNddNMdNNNmddhddyhhhyyyhdhhhhhy+++ysyhhhyMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMNdddhdhhys+yyNhoosmMNNmmmdhdhhyhdmmNMMMMNNmMmmo/-hmdhhs/:+/+sshodMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMdhdNdyyyssyhhhdhosymNNmhhysydmNMMMMMNNNMNdhyshyshmNMMMMMMmhy/--+o+ssMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMhydyooossssssssyhmmmddhosyhmNMMMMMMmdhyssdssshdMNddhdddNdNMMMMMms:-oosoNMMMMMMMMMMMMMMMMM
MMMMMMMMMNyhs++::ohsyhhhhdmmmmmddmdhsoydmddhhsyo:::+ysoo++oo/://ossyhmmNmNMMMds+yy+dMMMMMMMMMMMMMMMM
MMMMMMMMm+o///.-/://++oooo+oosyhddmmmdo..-/:::..-:::-::-//++oossoo+:/osyhdNNNNMNdysoyMMMMMMMMMMMMMMM
MMMMMMMm/--.://+yhdmNNMMMMMMNNmmdyo+++o+-```.-.----:++shmdNmmNNmNNmho+//+yyyhdmNMMmy+sMMMMMMMMMMMMMM
MMMMMMm:---+sydmNMMMMMNmddhydddhdhhhhs/-``..-://syhmNNMMMMMMMMMMMMMMNdyoo+osssydmMMMNyomMMMMMMMMMMMM
MMMMMN/-+yhddddNdhys++ssydmNNMMmdyso/:--..:::+osyhhdddhhhhdhhdhddNMNMMMmyssooosshdmMMMNhhMMMMMMMMMMM
MMMMMo+sddhhhyssosyydNNMMMmddhhdmds++ss+. ``.//:::/-:////oossssyyyhhdmNMMNyssoossshhdNNMNhmMMMMMMMMM
MMMNoshsyysssssshdNMMMmdhhmNNMmhsydmms.````  ./ohhddhyso+/+/++oossssyyhmNMMNhysooosyyhddmNmhNMMMMMMM
MMd++yhsss+osmmNMMMmdhdNNMMNhssmNNNy-` ```  ` `::+syddmmmmmdddhyssosssshdmNMMMdysoooosyhhdNNdhMMMMMM
Md+/oyssooydmMMMmdhdNMMMMmyosdMNmd+`` ` ````````-//:/osyhdddmNMMMNNmdyhyyhhdmNMNdys+oosyyhhdNmyNMMMM
N+o++o+/ydmNNmhsymMMMMMNy++hNMNNh-````````````````-+o+//+osyhhdmNMMMMMMmhhsyydmNMNdhsosoosyhdNNsNMMM
d+////syhmmdyshNMMMMMMh+ohmMNNNo`````````````````` `:yds++/:/osydmNNMMMMMMNdhhydmNMNdysoossohhNMyNMM
N+/-/ysshhyosmMMMNmNdo+ymMMNNN/``````````.````````````/NNmhyo+++/oyhdmNMMMMMMdyyydmNMmhhy+ossymMNsMM
Ms/-dysso/odNMNNNmms+smMMNmNN:  ```.``````   `````` ```-dMMMMNmddys+oyddmNNMMMNyyshhNNMmdhyssyyNMdmM
MM//m//+/smNdydmmd+ohNMNNMMN-```````````````````     ```.smNNMMMMMMNmhhmmmdNMMMMdhyyymNNNddyshymMMyM
MMN++--:ymyssymNmshdMMMMMMN- `````````````````.```````````:hNNMNMMMMNNNdMNmNMMMMMdhysyymNMdNdhydMMyM
MMMNo-:odo//smmhhdmMMMMMMN:`````.:+sydddhyo+++:::::.````````:yddmNMMMNMMmmNNNMMMMMyyysshNMMmddhmMMsM
MMMMMy+s::-:hmyyhdMMMMMMN: `.-:+syysyhdddmdhhhhhmmmdddys+:-```-ymdmNmNNNMNmNmmMMMMNyyssshNMmdhdmMMyM
MMMMMMy-.-:ooyyydMMMMMMN:`..---/symNNNNMMMMMMNMMNNMMMNMMNNmho:.`:ymdddhdmMmmNNNMMMMhssysydNmddddNMhM
MMMMMMM/:-:+yysyNMMMMMN/`.-:/sydmmmmNNNMMMMNNMMMNNNNNNNNNNNNmmd+``:hmhyhydNNmmNNMMMMyyyoyymdhdhdmMhM
MMMMMMMd-./ss/smMMMMMMo.:/+yyhmNNMNMNMmhNMMMMMNmmmNNMMMMMMNMNmdy+. `/hhyyhdNmmNNMMMMyyyyyhdhyhddmMyM
MMMMMMMM+:os:odNMMMNMy-./ooosyhdmMMMMMMmdMMMNhddmmmyshhdNMMMMMho+/.  `+hhyydNhdmNMMMsyyyhydhyhhhdNyM
MMMMMMMM/+s/:hmMMMNMd:..``...``.-//oNMMMMNNmddmho/:-:-.-:oossmms+//-```-hhyydddmNMMMoyhyyhdoyhdddNsM
MMMMMMMM/o+-+hdNMMNM:.../+++/::---.-+dNNmmy+ohs/:-.``.-:shso/:smhyyo-```.shyhhsdmNMN/yssshmssyhdmmsM
MMMMMMMMs//-yddmNNMd`.-oo::syyy+.```.ommmdyosdmd/:osso/:-/hNmy.sdmmmy:````ydyysdmNMMoyyyyhmoyhhdmydM
MMMMMMMMN//.sdddNNNy-.+o-/ssssyyy+.../Nmdyooymm+++/::/syhy/ohs/-/dNNmd:````shysodNNNy+ssyyyssydmdoMM
MMMMMMMMMh-.:ohhddmh-.+:--`- `/o+oo``.mhhds+oshso+-.`.h:-omho/oyyNMMMNy.````yso:ohmms+hyhhosyhmmydMM
MMMMMMMMMMh-.:+syydN:`-::o+::/mNdo+.`.mdNmd+omNdhmyhsdNyyydmssmMMMNMNNd-.`` /s+:./NdoosysoohdddhyMMM
MMMMMMMMMMMd::/++osss/:+../oyys+/:::-yMMMMNhymNNysydmNNNNmNMmdNNNNNNmMd-.`` `s:-`.my/oso+ohmmmhyMMMM
MMMMMMMMMMMMNs/:--:+s/yNy:/oyhy+:.`.oMMMMNNdsshdmdydNNNMMNNmmNMNNNNMNhs/``   +-:`.h-/:-:ohdddh+NMMMM
MMMMMMMMMMMMMMms/..:/.mNNmhhhy+:---oMMMMMMmdmmdmNmmmNNNNNmNNMNMNNNNNNy`-```` /-.`-:.`.:sydhs/sNMMMMM
MMMMMMMMMMMMMMMMMh:::.dmNMNmdhhss:sMMMMMMMmmmNNmNNNmmmmmNMMMMMMMMNNdmd-``` ``.-` ```.:/oo:-/dMMMMMMM
MMMMMMMMMMMMMMMMMMMd+.ommNMMMmds/oNMMMMNNNmdNNNMMNNNNNNNNNmNNMMNMNmddo+````.``.``..-:/:../hMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMN.-ddmMMNds-/mNNMMNddmddmmNNNNNMMMNNmmmddmNmmddmd--`  ..```..:::.-:odMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMh.syhmmh/..ymNMMMNdysmmmhydmNNMMMNNNmdddhdmddd+-+`  ``....-..-/ymMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMm..o+yyo..-ymNNMMMd++NMNdssshmNNNNNmNdhhho+hhs```.` ./-.`-/ohmMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMN+``.sso/.-.-ymmmmy/-:+ss++Mh+shmNNmmdddho+`.s/`:`-```-.-.sMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMh:-``+hho::.../o///:-..:+oyNMNhshddmmddhs/+/ `: -`/` ``/...MMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMyo.`.md:o:..---.--o:.-+so:+syNNddhhdddss`s::  .`.:`..``.-:MMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMo.``ss//--:.--o::+-/-.-.:-./sso++sysh-y`-/o` .:/-.-.:....MMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMm--`--+/:+-/:-ds.o:o//::-/-.-/:-:-:/:`+`.+o.`:.s./:`-+.- /hNMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMNo.`../:.s:yo:hms-s:o-+-:+::..::/+:.o.y/-/y..::o:/``-.-`   .+dMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMN.../-y--+-+s/:::.-/.--.````..`-yy/+o-ds+hs-.-//`-``:`.`      :hMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMd``/+/o...-./shddhshddms/.`..``:+o:++:o/:oh``/-+``  ```. `      :dNMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMM+:`s/s+/+:-..`-//:////:.-`.`````.s`.o-/+:s+`-o/o.``..`` ``        :yNMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMN/- s/+:///.s-...`` `..../`-```` +h`+o:/:o/`:o/o-/``---``````        .odNMMMMMM
MMMMMMMMMMMMMMMMMMMMMm/`.-::++s./y.::.`` `+.:..-.``.`/o/`/d-/o+`:s+./--`..--` `````      `  `.+dNMMM
MMMMMMMMMMMMMMMMMMMMMd::--.//ss:s./:.`` `:d.-:`-..-://-.`.+//:.-+/.:`s`.--.` ```.` ````  `` `  `-omM
MMMMMMMMMMMMMMMMMMMNd:+o/:..+s:/-/./:.`...m.--`:/-/o/-`...:+.--o.+ ..- `:.-  `````` ````` `       `:
MMMMMMMMMMMMMMMMMNs- /+ss..//---od./o`-:-.s--..o//o:/`.:`/.+`..o`+`.` `.-`-` `..`.` ``` ``.``   `
MMMMMMMMMMMMMMNy+`  `:os.--...+ssy--o.-:o..::./s+o-+.---.-+.--`:`:`-``` - `````````.```````.``     `
MMMMMMMMMMMNy/`  `  `-o:-+-`-ssss+:/-/:/o``.s-::s/:`/.. -`-`.:`o`.-:`/-`` ``..```..``.``. ````` `  `
MMMMMMMMMm+.     ````..o+/``o++y/+/h.:/:o```:/.`ss- o`:`/-.`/..o`..-/./`  `.`-``.`.....```-..````.`.
MMMMMMMmy.``````` ```..`s```:.s/o/+s-oys/--`/y--os-`/`:`+:`:o/.. `-`-`` ``.-`..`--.`-..--.`-.-.`-..-
MMMMMMyy/..``` ``````` ./.``.-+/o:y+syhhs:so:y-:hs/.: `.h:-`//:``+-:-.....-.``..../-:-.-.:-.:-./:o//
MMMMMMmho:.-..```````.``.```..+`o/s/h+sdoyso:h.//:/.```o-./.`s/`.d-:----:-`.-..:-..-----..:-:++syshh
MMMMMMMMmy+/:.-.-...-..-..`.....o:/++h+moyh:/o-:+--:..-o.`.`.h--:+-`---:---.-/--//:-::-...-:smmMMMMM
MMMMMMMMMMNdy+o:---..`...-.:--.`+.-+:o:Noso::+:.::....-..``.o:.`-``--..`-..--://:-::--//:+sdMMMMMMMM
MMMMMMMMMMMMMMMmdy+/::..``.--..`.`-:-/.ho:---/:.`-.:``.```-o/-..-.-...-..-/:///+///ssohymMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMNm/:-..````:`.`../`.o/``-:....``  ` ///--.--...-.--/:/++/ysyhhdMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMmy+::...``` ```.``-```/.` .`.   -/:---.:----::/oyhmmMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMds+---.`..`.```.``.:  `+`  -+/-/-/////sshmNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNy+:-`..-//+/::::++/-.-/:/:++sdmNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMhy+:////+/++/shyhhmdmNNNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNds::::/:osmMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM

                                                  
                                                  
`7MMF'  `7MMF'                                    
  MM      MM                                      
  MM      MM   ,6"Yb.  M""MMV .gP"Ya  7MMpMMMb.
  MMmmmmmmMM  8)   MM  '  AMV ,M'   Yb  MM    MM
  MM      MM   ,pm9MM    AMV  8M""""""  MM    MM
  MM      MM  8M   MM   AMV  ,YM.    ,  MM    MM
.JMML.  .JMML.`Moo9^Yo.AMMmmmM `Mbmmd'.JMML  JMML.



Welcome to the Hazen Command Line Interface
Usage:
    hazen <task> <folder>
    hazen -h|--help
    hazen -v|--version
Options:
    <task>  snr | slice_position | slice_width | spatial_resolution | uniformity | ghosting
    <folder>    Directory containing dicom files to be processed.
    -h --help  Show this screen.
    -v --version  Show version.
"""
from docopt import docopt
import hazenlib
import os
import importlib
import pydicom
import numpy as np

__version__ = '0.1.dev'
__all__ = ['snr', 'slice_position', 'slice_width', 'spatial_resolution', 'uniformity', 'ghosting', 'utils']




def is_enhanced_dicom(dcm: pydicom.Dataset) -> bool:
    """

    Parameters
    ----------
    dcm

    Returns
    -------
    bool

    Raises
    ------
    Exception
     Unrecognised SOPClassUID

    """

    if dcm.SOPClassUID == '1.2.840.10008.5.1.4.1.1.4.1':
        return True
    elif dcm.SOPClassUID == '1.2.840.10008.5.1.4.1.1.4':
        return False
    else:
        raise Exception('Unrecognised SOPClassUID')


def get_manufacturer(dcm: pydicom.Dataset) -> str:
    supported = ['GE', 'GE MEDICAL SYSTEMS', 'SIEMENS', 'Philips']  # Siemens has to be upper-case

    if dcm.Manufacturer in supported:
        return dcm.Manufacturer
    else:
        raise Exception('Manufacturer not recognised')


def find_circle(dcm: pydicom.Dataset):
    """
    Finds a circle that fits the outline of the phantom using the Hough Transform

    Parameters:
    ---------------
    a: image array (should be uint8)

    Returns:
    ---------------
    cenx, ceny, cradius: int, int, int
        xy pixel coordinates of the centre of the phantom
        radius of the phantom in pixels

    Raises
    ------
    Exception:
        Wrong number of circles detected, check image.

    """

    a = dcm.pixel_array
    a = ((a / a.max()) * 256).astype('uint8')

    # Perform Hough transform to find circle
    circles = cv.HoughCircles(a, cv.HOUGH_GRADIENT, 1, 200, param1=30,
                              param2=45, minRadius=0, maxRadius=0)

    # Check that a single phantom was found
    if len(circles) == 1:
        pass

    else:
        raise Exception("Wrong number of circles detected, check image.")

    # Draw circle onto original image
    circles = np.uint16(np.around(circles))
    for i in circles[0, :]:
        # draw the outer circle
        cv.circle(a, (i[0], i[1]), i[2], 128, 2)
        # draw the center of the circle
        cv.circle(a, (i[0], i[1]), 2, 128, 2)

    cenx = i[0]
    ceny = i[1]
    cradius = i[2]
    return cenx, ceny, cradius


def main():
    arguments = docopt(__doc__, version=__version__)
    task = importlib.import_module(f"hazenlib.{arguments['<task>']}")
    folder = arguments['<folder>']
    files = [os.path.join(folder, x) for x in os.listdir(folder)]
    return task.main(files)

